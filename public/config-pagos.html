<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuración de Pagos - MUNDO PATAS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/sistema.html">
                <i class="fas fa-paw me-2"></i>MUNDO PATAS
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/sistema.html">
                            <i class="fas fa-arrow-left me-1"></i>Volver al Sistema
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-credit-card me-2"></i>
                            Configuración de Métodos de Pago
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Importante:</strong> Configura tus métodos de pago para que los clientes puedan agendar citas. 
                            El pago es obligatorio para confirmar la cita.
                        </div>

                        <form id="configPagosForm">
                            <!-- Precio de Consulta -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Precio de Consulta</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Precio por consulta ($)</label>
                                        <input type="number" class="form-control" id="precio_consulta" 
                                               min="0" step="0.01" required>
                                        <small class="text-muted">Este será el monto que se cobrará por cada cita agendada</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Transferencia Bancaria -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="acepta_transferencia">
                                        <label class="form-check-label" for="acepta_transferencia">
                                            <h5 class="mb-0"><i class="fas fa-university me-2"></i>Transferencia Bancaria / CBU</h5>
                                        </label>
                                    </div>
                                </div>
                                <div class="card-body" id="transferencia-config">
                                    <div class="mb-3">
                                        <label class="form-label">CBU / CVU</label>
                                        <input type="text" class="form-control" id="cbu_cvu" 
                                               placeholder="0000003100012345678901">
                                        <small class="text-muted">22 dígitos de tu CBU o CVU</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Alias</label>
                                        <input type="text" class="form-control" id="alias_cbu" 
                                               placeholder="MUNDOPATAS.VET">
                                        <small class="text-muted">Alias de tu cuenta bancaria</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Titular de la cuenta</label>
                                        <input type="text" class="form-control" id="titular_cuenta" 
                                               placeholder="Juan Pérez">
                                    </div>
                                </div>
                            </div>

                            <!-- Mercado Pago -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="acepta_mercadopago">
                                        <label class="form-check-label" for="acepta_mercadopago">
                                            <h5 class="mb-0"><i class="fas fa-mobile-alt me-2"></i>Mercado Pago</h5>
                                        </label>
                                    </div>
                                </div>
                                <div class="card-body" id="mercadopago-config">
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        Para usar Mercado Pago necesitas crear una aplicación en 
                                        <a href="https://www.mercadopago.com.ar/developers" target="_blank">Mercado Pago Developers</a>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Public Key</label>
                                        <input type="text" class="form-control" id="mercadopago_public_key" 
                                               placeholder="APP_USR-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                                        <small class="text-muted">Clave pública de tu aplicación de Mercado Pago</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Access Token</label>
                                        <input type="password" class="form-control" id="mercadopago_access_token" 
                                               placeholder="APP_USR-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                                        <small class="text-muted">Token de acceso de tu aplicación (se guarda encriptado)</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Efectivo -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="acepta_efectivo">
                                        <label class="form-check-label" for="acepta_efectivo">
                                            <h5 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i>Efectivo (Pago en consultorio)</h5>
                                        </label>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted mb-0">
                                        El cliente puede reservar la cita y pagar en efectivo al momento de la consulta.
                                        La cita quedará como "Pendiente de pago" hasta que confirmes el pago.
                                    </p>
                                </div>
                            </div>

                            <!-- Integración ARCA/AFIP -->
                            <div class="card mb-4 border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0"><i class="fas fa-file-invoice me-2"></i>Integración con ARCA (AFIP)</h5>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Configura tu CUIT y credenciales de ARCA para sincronizar facturas electrónicas.
                                        Las facturas generadas en ARCA se listarán automáticamente en el sistema.
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">CUIT</label>
                                        <input type="text" class="form-control" id="arca_cuit" 
                                               placeholder="20-12345678-9" maxlength="13">
                                        <small class="text-muted">Tu CUIT registrado en AFIP</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">API Key de ARCA</label>
                                        <input type="password" class="form-control" id="arca_api_key" 
                                               placeholder="Tu clave de API de ARCA">
                                        <small class="text-muted">Obtén tu API Key desde el portal de ARCA</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Punto de Venta</label>
                                        <input type="number" class="form-control" id="arca_punto_venta" 
                                               min="1" value="1">
                                        <small class="text-muted">Número de punto de venta configurado en AFIP</small>
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-save me-2"></i>Guardar Configuración
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = window.location.origin;

        // Verificar autenticación
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Debes iniciar sesión para acceder a esta página');
                window.location.href = '/';
                return;
            }

            loadConfiguracion();
            setupEventListeners();
        });

        // Cargar configuración actual
        async function loadConfiguracion() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/api/veterinario/config-pagos`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const config = await response.json();
                    
                    // Llenar formulario
                    document.getElementById('precio_consulta').value = config.precio_consulta || 5000;
                    document.getElementById('cbu_cvu').value = config.cbu_cvu || '';
                    document.getElementById('alias_cbu').value = config.alias_cbu || '';
                    document.getElementById('titular_cuenta').value = config.titular_cuenta || '';
                    document.getElementById('mercadopago_public_key').value = config.mercadopago_public_key || '';
                    
                    document.getElementById('acepta_transferencia').checked = config.acepta_transferencia;
                    document.getElementById('acepta_mercadopago').checked = config.acepta_mercadopago;
                    document.getElementById('acepta_efectivo').checked = config.acepta_efectivo;
                    
                    document.getElementById('arca_cuit').value = config.arca_cuit || '';
                    document.getElementById('arca_punto_venta').value = config.arca_punto_venta || 1;

                    toggleSections();
                }
            } catch (error) {
                console.error('Error cargando configuración:', error);
            }
        }

        // Event listeners para mostrar/ocultar secciones
        function setupEventListeners() {
            document.getElementById('acepta_transferencia').addEventListener('change', toggleSections);
            document.getElementById('acepta_mercadopago').addEventListener('change', toggleSections);
            
            document.getElementById('configPagosForm').addEventListener('submit', guardarConfiguracion);
        }

        function toggleSections() {
            const transferenciaEnabled = document.getElementById('acepta_transferencia').checked;
            const mercadopagoEnabled = document.getElementById('acepta_mercadopago').checked;
            
            document.getElementById('transferencia-config').style.display = transferenciaEnabled ? 'block' : 'none';
            document.getElementById('mercadopago-config').style.display = mercadopagoEnabled ? 'block' : 'none';
        }

        // Guardar configuración
        async function guardarConfiguracion(e) {
            e.preventDefault();

            const data = {
                precio_consulta: parseFloat(document.getElementById('precio_consulta').value),
                cbu_cvu: document.getElementById('cbu_cvu').value,
                alias_cbu: document.getElementById('alias_cbu').value,
                titular_cuenta: document.getElementById('titular_cuenta').value,
                mercadopago_public_key: document.getElementById('mercadopago_public_key').value,
                mercadopago_access_token: document.getElementById('mercadopago_access_token').value,
                acepta_transferencia: document.getElementById('acepta_transferencia').checked,
                acepta_mercadopago: document.getElementById('acepta_mercadopago').checked,
                acepta_efectivo: document.getElementById('acepta_efectivo').checked,
                arca_cuit: document.getElementById('arca_cuit').value,
                arca_api_key: document.getElementById('arca_api_key').value,
                arca_punto_venta: parseInt(document.getElementById('arca_punto_venta').value)
            };

            // Validar que al menos un método esté habilitado
            if (!data.acepta_transferencia && !data.acepta_mercadopago && !data.acepta_efectivo) {
                alert('Debes habilitar al menos un método de pago');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/api/veterinario/config-pagos`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('✅ Configuración guardada exitosamente');
                    window.location.href = '/sistema.html';
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.error);
                }
            } catch (error) {
                console.error('Error guardando configuración:', error);
                alert('Error al guardar la configuración');
            }
        }
    </script>
</body>
</html>
